<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master PRO | Cloud & Secure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --accent: #f97316; --bg: #0f172a; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: white; display: flex; justify-content: center; padding: 15px; }
        .container { background: rgba(30, 41, 59, 0.8); border-radius: 20px; padding: 20px; width: 100%; max-width: 650px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        h1 { text-align: center; color: var(--accent); margin: 10px 0; }
        .login-box, .pass-box { text-align: center; padding: 40px 0; }
        .btn-google { background: white; color: black; border: none; padding: 15px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 0 auto; }
        
        #app, #pass-screen { display: none; }
        .input-group { display: grid; grid-template-columns: 2.5fr 1fr 50px; gap: 8px; margin: 20px 0; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; outline: none; width: 100%; box-sizing: border-box; }
        .btn-main { background: var(--accent); border: none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; padding: 12px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 10px; color: #94a3b8; padding: 10px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; font-size: 13px; }
        .time-col { color: #64748b; font-size: 11px; }
        
        .total-box { background: var(--accent); padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 20px; }
        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-sec { flex: 1; background: #334155; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 13px; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 12px; }
        .btn-link { background: none; border: none; color: #94a3b8; cursor: pointer; text-decoration: underline; font-size: 11px; }

        #pdf-ui { display: none; background: white; color: black; padding: 30px; }
        #pdf-ui table { width: 100%; border: 1px solid black; border-collapse: collapse; }
        #pdf-ui td, #pdf-ui th { border: 1px solid black; padding: 8px; color: black; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="login-box">
        <h1>MASTER <span style="color:white">PRO</span></h1>
        <button class="btn-google" id="btn-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa/google.svg" width="20">
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
    </div>

    <div id="pass-screen" class="pass-box">
        <h2 id="pass-title">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</h2>
        <input type="password" id="entry-pass" placeholder="****" style="text-align:center; font-size: 24px; max-width: 200px;">
        <br><br>
        <button class="btn-main" id="btn-check-pass" style="width: 200px;">–û–¢–ö–†–´–¢–¨</button>
        <br><br>
        <button class="btn-link" id="btn-reset-pass">–ó–∞–±—ã–ª –ø–∞—Ä–æ–ª—å / –°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <div id="app">
        <div class="user-bar">
            <div>
                <b id="user-name"></b><br>
                <button class="btn-link" id="btn-change-pass">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
            <button class="btn-link" id="btn-logout" style="color:#ef4444;">–í—ã—Ö–æ–¥</button>
        </div>

        <div class="input-group">
            <input type="text" id="task" list="history" placeholder="–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏?">
            <datalist id="history"></datalist>
            <input type="number" id="price" placeholder="–°—É–º–º–∞">
            <button class="btn-main" id="btn-add" style="width: 50px;">+</button>
        </div>

        <table>
            <thead><tr><th>–î–∞—Ç–∞ / –í—Ä–µ–º—è</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="total-box">
            <span>–ò–¢–û–ì–û:</span>
            <span id="total-sum">0 —Å–º–Ω</span>
        </div>

        <div class="nav-btns">
            <button class="btn-sec" id="btn-pdf">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF</button>
            <button class="btn-sec" style="color: #ef4444;" id="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="pdf-ui">
    <h1 style="text-align:center;">–û–¢–ß–ï–¢ –ú–ê–°–¢–ï–†–ê</h1>
    <p id="pdf-master"></p>
    <div id="pdf-table"></div>
    <h2 style="text-align:right; margin-top:20px;">–ò—Ç–æ–≥–æ: <span id="pdf-total"></span></h2>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBo5nsIBswK0NnQS89QdsD517Xqbd_jK2U",
        authDomain: "dyadya-app.firebaseapp.com",
        projectId: "dyadya-app",
        storageBucket: "dyadya-app.firebasestorage.app",
        messagingSenderId: "396455935954",
        appId: "1:396455935954:web:933d06290ce7642099d20b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê –ò –ü–ê–†–û–õ–Ø ---
    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('pass-screen').style.display = 'block';
            
            const savedPass = localStorage.getItem('app_pass_' + user.uid);
            if (!savedPass) {
                document.getElementById('pass-title').innerText = "–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å";
            }
        }
    });

    document.getElementById('btn-check-pass').onclick = () => {
        const input = document.getElementById('entry-pass').value;
        const key = 'app_pass_' + currentUser.uid;
        const saved = localStorage.getItem(key);

        if (!saved) {
            if (input.length > 0) {
                localStorage.setItem(key, input);
                startApp();
            } else { alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É!"); }
        } else {
            if (input === saved) { startApp(); } 
            else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!"); }
        }
    };

    document.getElementById('btn-change-pass').onclick = () => {
        if(confirm("–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å?")){
            localStorage.removeItem('app_pass_' + currentUser.uid);
            location.reload();
        }
    };

    document.getElementById('btn-reset-pass').onclick = () => {
        if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å? –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–∏ –≤—Ö–æ–¥–µ.")){
            localStorage.removeItem('app_pass_' + currentUser.uid);
            location.reload();
        }
    };

    function startApp() {
        document.getElementById('pass-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('user-name').innerText = currentUser.displayName;
        loadData(currentUser.uid);
    }

    // --- –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò ---
    document.getElementById('btn-add').onclick = async () => {
        const task = document.getElementById('task').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        if (task && price) {
            await addDoc(collection(db, "expenses"), {
                uid: currentUser.uid,
                desc: task,
                price: price,
                date: new Date() // Firebase —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∏ –¥–∞—Ç—É, –∏ –≤—Ä–µ–º—è
            });
            document.getElementById('task').value = "";
            document.getElementById('price').value = "";
            document.getElementById('task').focus();
        }
    };

    function loadData(uid) {
        const q = query(collection(db, "expenses"), orderBy("date", "desc"));
        onSnapshot(q, (snap) => {
            const body = document.getElementById('table-body');
            const history = document.getElementById('history');
            body.innerHTML = "";
            history.innerHTML = "";
            let total = 0;
            let words = new Set();

            snap.forEach(docSnap => {
                const d = docSnap.data();
                if(d.uid === uid) {
                    const dateObj = d.date.toDate();
                    const dateStr = dateObj.toLocaleDateString();
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const row = `<tr>
                        <td>${dateStr} <br><span class="time-col">${timeStr}</span></td>
                        <td>${d.desc}</td>
                        <td>${formatNumber(d.price)} —Å–º–Ω</td>
                    </tr>`;
                    body.innerHTML += row;
                    total += d.price;
                    words.add(d.desc);
                }
            });

            words.forEach(w => history.innerHTML += `<option value="${w}">`);
            document.getElementById('total-sum').innerText = formatNumber(total) + " —Å–º–Ω";
        });
    }

    document.getElementById('btn-pdf').onclick = () => {
        const ui = document.getElementById('pdf-ui');
        document.getElementById('pdf-master').innerText = "–ú–∞—Å—Ç–µ—Ä: " + currentUser.displayName;
        document.getElementById('pdf-table').innerHTML = "<table>" + document.querySelector('table').innerHTML + "</table>";
        document.getElementById('pdf-total').innerText = document.getElementById('total-sum').innerText;
        ui.style.display = 'block';
        html2pdf().from(ui).save().then(() => ui.style.display = 'none');
    };

    document.getElementById('btn-clear').onclick = async () => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?")) {
            const q = query(collection(db, "expenses"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            await Promise.all(snap.docs.map(d => deleteDoc(doc(db, "expenses", d.id))));
        }
    };
</script>
</body>
</html>