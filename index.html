<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master PRO | Cloud & Secure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --accent: #f97316; --bg: #0f172a; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: white; display: flex; justify-content: center; padding: 15px; }
        .container { background: rgba(30, 41, 59, 0.8); border-radius: 20px; padding: 20px; width: 100%; max-width: 650px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        h1 { text-align: center; color: var(--accent); margin: 10px 0; }
        .login-box, .pass-box { text-align: center; padding: 40px 0; }
        .btn-google { background: white; color: black; border: none; padding: 15px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin: 0 auto; }
        
        #app, #pass-screen { display: none; }
        .input-group { display: grid; grid-template-columns: 2.5fr 1fr 50px; gap: 8px; margin: 20px 0; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; outline: none; width: 100%; box-sizing: border-box; }
        .btn-main { background: var(--accent); border: none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; padding: 12px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 10px; color: #94a3b8; padding: 10px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #1e293b; font-size: 13px; }
        .time-col { color: #64748b; font-size: 11px; }
        
        .total-box { background: var(--accent); padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; margin-top: 20px; }
        .nav-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-sec { flex: 1; background: #334155; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 13px; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 12px; }
        .btn-link { background: none; border: none; color: #94a3b8; cursor: pointer; text-decoration: underline; font-size: 11px; }

        #pdf-ui { display: none; background: white; color: black; padding: 30px; }
        #pdf-ui table { width: 100%; border: 1px solid black; border-collapse: collapse; page-break-inside: auto; }
        #pdf-ui table tr { page-break-inside: avoid; }
        #pdf-ui td, #pdf-ui th { border: 1px solid black; padding: 8px; color: black; }

        .action-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 12px; margin: 0 5px; }
        .edit-input { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="login-box">
        <h1>MASTER <span style="color:white">PRO</span></h1>
        <button class="btn-google" id="btn-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa/google.svg" width="20">
            Войти через Google
        </button>
    </div>

    <div id="pass-screen" class="pass-box">
        <h2 id="pass-title">Введите пароль доступа</h2>
        <input type="password" id="entry-pass" placeholder="****" style="text-align:center; font-size: 24px; max-width: 200px;">
        <br><br>
        <button class="btn-main" id="btn-check-pass" style="width: 200px;">ОТКРЫТЬ</button>
        <br><br>
        <button class="btn-link" id="btn-reset-pass">Забыл пароль / Сбросить</button>
    </div>

    <div id="app">
        <div class="user-bar">
            <div>
                <b id="user-name"></b><br>
                <button class="btn-link" id="btn-change-pass">Изменить пароль</button>
            </div>
            <button class="btn-link" id="btn-logout" style="color:#ef4444;">Выход</button>
        </div>

        <div class="input-group">
            <input type="text" id="task" list="history" placeholder="Что сделали?">
            <datalist id="history"></datalist>
            <input type="number" id="price" placeholder="Сумма">
            <button class="btn-main" id="btn-add" style="width: 50px;">+</button>
        </div>

        <table>
            <thead><tr><th>Дата / Время</th><th>Описание</th><th>Сумма</th><th>Действия</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="total-box">
            <span>ИТОГО:</span>
            <span id="total-sum">0 смн</span>
        </div>

        <div class="nav-btns">
            <button class="btn-sec" id="btn-pdf">⬇️ Скачать TXT</button>
        </div>
    </div>
</div>

<div id="pdf-ui">
    <h1 id="pdf-title" style="text-align:center;">ОТЧЕТ МАСТЕРА</h1>
    <p id="pdf-master"></p>
    <div id="pdf-table"></div>
    <h2 style="text-align:right; margin-top:20px;">Итого: <span id="pdf-total"></span></h2>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBo5nsIBswK0NnQS89QdsD517Xqbd_jK2U",
        authDomain: "dyadya-app.firebaseapp.com",
        projectId: "dyadya-app",
        storageBucket: "dyadya-app.firebasestorage.app",
        messagingSenderId: "396455935954",
        appId: "1:396455935954:web:933d06290ce7642099d20b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let currentMonthYear = '';

    function formatNumber(num) {
        // безопасное форматирование числа, возвращаем '0' для нечисловых значений
        const n = Number(num);
        if (!isFinite(n)) return '0';
        return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // --- ЛОГИКА ВХОДА И ПАРОЛЯ ---
    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('pass-screen').style.display = 'block';
            
            const savedPass = localStorage.getItem('app_pass_' + user.uid);
            if (!savedPass) {
                document.getElementById('pass-title').innerText = "Придумайте новый пароль";
            }
        }
    });

    document.getElementById('btn-check-pass').onclick = () => {
        const input = document.getElementById('entry-pass').value;
        const key = 'app_pass_' + currentUser.uid;
        const saved = localStorage.getItem(key);

        if (!saved) {
            if (input.length > 0) {
                localStorage.setItem(key, input);
                startApp();
            } else { alert("Введите хотя бы одну цифру!"); }
        } else {
            if (input === saved) { startApp(); } 
            else { alert("Неверный пароль!"); }
        }
    };

    document.getElementById('btn-change-pass').onclick = () => {
        if(confirm("Хотите изменить пароль?")){
            localStorage.removeItem('app_pass_' + currentUser.uid);
            location.reload();
        }
    };

    document.getElementById('btn-reset-pass').onclick = () => {
        if(confirm("Сбросить пароль? Вам нужно будет создать новый при входе.")){
            localStorage.removeItem('app_pass_' + currentUser.uid);
            location.reload();
        }
    };

    function startApp() {
        document.getElementById('pass-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('user-name').innerText = currentUser.displayName;
        loadData(currentUser.uid);
    }

    // --- РАБОТА С ДАННЫМИ ---
    document.getElementById('btn-add').onclick = async () => {
        const task = document.getElementById('task').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        if (task && price) {
            await addDoc(collection(db, "expenses"), {
                uid: currentUser.uid,
                desc: task,
                price: price,
                date: new Date() // Firebase сохранит и дату, и время
            });
            document.getElementById('task').value = "";
            document.getElementById('price').value = "";
            document.getElementById('task').focus();
        }
    };

    function loadData(uid) {
        const q = query(collection(db, "expenses"), orderBy("date", "desc"));
        onSnapshot(q, (snap) => {
            const body = document.getElementById('table-body');
            const history = document.getElementById('history');
            body.innerHTML = "";
            history.innerHTML = "";
            let total = 0;
            let words = new Set();
 
            snap.forEach(docSnap => {
                const d = docSnap.data();
                if(d.uid === uid) {
                    const dateObj = d.date.toDate();
                    const dateStr = dateObj.toLocaleDateString();
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
 
                    // безопасный вывод суммы (если d.price некорректен — покажем 0)
                    const priceNum = Number(d.price);
                    const priceDisplay = isFinite(priceNum) ? formatNumber(priceNum) + ' смн' : '0 смн';
                    const row = `<tr data-id="${docSnap.id}">
                        <td>${dateStr} <br><span class="time-col">${timeStr}</span></td>
                        <td>${d.desc}</td>
                        <td>${priceDisplay}</td>
                        <td>
                            <button class="action-btn" onclick="editRow(this)">Изменить</button>
                            <button class="action-btn" onclick="deleteRow('${docSnap.id}')">Удалить</button>
                        </td>
                    </tr>`;
                    body.innerHTML += row;
                    if (isFinite(priceNum)) total += priceNum;
                     words.add(d.desc);
                }
            });

            // Обновить текущий месяц/год на основе самой новой записи
            if (snap.docs.length > 0) {
                const latestDoc = snap.docs[0].data();
                const dateObj = latestDoc.date.toDate();
                const monthNames = ["ЯНВАРЯ", "ФЕВРАЛЯ", "МАРТА", "АПРЕЛЯ", "МАЯ", "ИЮНЯ", "ИЮЛЯ", "АВГУСТА", "СЕНТЯБРЯ", "ОКТЯБРЯ", "НОЯБРЯ", "ДЕКАБРЯ"];
                currentMonthYear = monthNames[dateObj.getMonth()] + ' ' + dateObj.getFullYear();
            } else {
                currentMonthYear = '';
            }

            words.forEach(w => history.innerHTML += `<option value="${w}">`);
            document.getElementById('total-sum').innerText = formatNumber(total) + " смн";
        });
    }

    window.editRow = function(btn) {
        const row = btn.closest('tr');
        const descCell = row.cells[1];
        const priceCell = row.cells[2];
        const actionsCell = row.cells[3];

        const originalDesc = descCell.innerText;
        const originalPrice = priceCell.innerText.replace(' смн', '').replace(/\./g, '');

        descCell.innerHTML = `<input class="edit-input" type="text" value="${originalDesc}">`;
        priceCell.innerHTML = `<input class="edit-input" type="number" value="${originalPrice}">`;
        actionsCell.innerHTML = `
            <button class="action-btn" onclick="saveRow('${row.dataset.id}', this)">Сохранить</button>
            <button class="action-btn" onclick="cancelEdit(this, '${originalDesc}', '${originalPrice}')">Отмена</button>
        `;
    };

    window.saveRow = async function(id, btn) {
        const row = btn.closest('tr');
        const descInput = row.cells[1].querySelector('input');
        const priceInput = row.cells[2].querySelector('input');

        const newDesc = descInput.value.trim();
        const newPrice = parseFloat(priceInput.value);

        if (newDesc && newPrice) {
            await updateDoc(doc(db, "expenses", id), { desc: newDesc, price: newPrice });
        }
    };

    window.cancelEdit = function(btn, originalDesc, originalPrice) {
        const row = btn.closest('tr');
        row.cells[1].innerHTML = originalDesc;
        row.cells[2].innerHTML = formatNumber(originalPrice) + ' смн';
        row.cells[3].innerHTML = `
            <button class="action-btn" onclick="editRow(this)">Изменить</button>
            <button class="action-btn" onclick="deleteRow('${row.dataset.id}')">Удалить</button>
        `;
    };

    window.deleteRow = async function(id) {
        if (confirm("Удалить эту запись?")) {
            await deleteDoc(doc(db, "expenses", id));
        }
    };

    document.getElementById('btn-pdf').onclick = () => {
         if (!currentUser) { alert('Сначала войдите'); return; }
         const title = currentMonthYear ? 'ОТЧЕТ ЗА ' + currentMonthYear : 'ОТЧЕТ МАСТЕРА';
         const master = 'Мастер: ' + currentUser.displayName;
         const lines = [];
         lines.push(title);
         lines.push(master);
         lines.push('');
        lines.push('Дата/Время\tОписание\tСумма (смн)');
  
         let totalNum = 0;
  
         document.querySelectorAll('#table-body tr').forEach(tr => {
             const dateCell = (tr.cells[0] && tr.cells[0].innerText) ? tr.cells[0].innerText.replace(/\s+/g, ' ').trim() : '';
             const desc = (tr.cells[1] && tr.cells[1].innerText) ? tr.cells[1].innerText.trim() : '';
             const priceText = (tr.cells[2] && tr.cells[2].innerText) ? tr.cells[2].innerText.trim() : '';
             // Удаляем нечисловые символы для суммирования
             const numStr = priceText.replace(/[^\d,.\-]/g, '').replace(/\./g, '').replace(',', '.');
             const num = parseFloat(numStr) || 0;
             totalNum += num;
            // В файл записываем только отображаемую сумму (без повторного числового столбца)
            lines.push(`${dateCell}\t${desc}\t${priceText}`);
         });
  
         lines.push('');
         const formattedTotal = formatNumber(totalNum) + ' смн';
         lines.push('Итого: ' + formattedTotal);
  
         const blob = new Blob([lines.join('\r\n')], { type: 'text/plain;charset=utf-8' });
         const url = URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         a.download = 'report.txt';
         document.body.appendChild(a);
         a.click();
         a.remove();
         URL.revokeObjectURL(url);
     };
</script>
</body>
</html>
